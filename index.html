<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç„¡é™æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ»ã‚¸ãƒ£ãƒ³ãƒ—ã‚²ãƒ¼ãƒ  - å®Œæˆç‰ˆ</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #333;
            font-family: 'Arial', sans-serif;
        }
        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background-color: #87CEEB; /* ç©ºè‰² */
            touch-action: none;
        }
        #audio-elements {
            display: none; /* ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¦ç´ ã¯è¡¨ç¤ºã—ãªã„ */
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="audio-elements">
        <!-- BGM (8bité¢¨ãƒ«ãƒ¼ãƒ—) -->
        <audio id="bgm" loop preload="auto">
            <source src="data:audio/wav;base64,UklGRmYBAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABgAAABkYXRhWQEAAACY/wD9/wAA/v8A/P8AAP7/APz/AAD9/wABAAEAAgABAAIAAQABAP7/APz/AAD8/wD7/wD5/wD4/wD2/wD1/wD0/wD0/wDz/wDz/wADAAEAAgD//wAA/v8A/f8AAPz/APv/APn/APf/APX/APL/APL/APL/APQ/APg/APp/APv/APv/APz/AP3/AP7/AP//AAMABAADAP//AAD+/wD9/wD8/wD7/wD6/wD4/wD2/wD1/wD1/wD0/wD0/wADAAEAAgD//wAA/v8A/f8AAPz/APv/APn/APf/APX/APL/APL/APL/APQ/APg/APp/APv/APv/APz/AP3/AP7/AP//AAMABAADAP//AAD+/wD9/wD8/wD7/wD6/wD4/wD2/wD1/wD1/wD0/wD0/wADAAEAAQAAAA==" type="audio/wav">
        </audio>
        <!-- ã‚¸ãƒ£ãƒ³ãƒ—éŸ³ (Pew!) -->
        <audio id="jumpSound" preload="auto">
            <source src="data:audio/wav;base64,UklGRlgAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAAABkYXRhWAAAAAAAAP//AAAA//8AAAAA//8A/v/9AgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAFAAcACQAIAAYAAgD9APv/+wD5APoA+wD7AP0A/gD+AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AP8A/wD/AA==" type="audio/wav">
        </audio>
        <!-- ã‚¢ã‚¤ãƒ†ãƒ å–å¾—éŸ³ (Coin!) -->
        <audio id="itemSound" preload="auto">
            <source src="data:audio/wav;base64,UklGRkIAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAAABkYXRhQgAAAAAAAPD/AAAA8P8AABAQAAAgIAAAQEAACEhIAAFJSQABSUkAAUlJAAGBgQAhISEAERERAADw/wAA8P8AAAAQEA==" type="audio/wav">
        </audio>
        <!-- éšœå®³ç‰©é£›ã³è¶ŠãˆéŸ³ (Ding!) -->
        <audio id="clearSound" preload="auto">
            <source src="data:audio/wav;base64,UklGRlYAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAAABkYXRhUgAAAAAAAP//AAAA//8AAPD/AADw/wAA8P8AABAQAAAYGAAAI CAAACAgAAAgIAAAQEAAAEBAAAPD/AADw/wAA//8AAAAA//8AAAAA//8A//8A//8AAAAA//8A" type="audio/wav">
        </audio>
        <!-- ãƒ€ãƒ¡ãƒ¼ã‚¸éŸ³ (Hit!) -->
        <audio id="gameOverSound" preload="auto">
            <source src="data:audio/wav;base64,UklGRkAAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAAABkYXRhQAAAAAAAABAAAAAQEAAGBgQABQUkAAUlJAAEhIQAAQEAABDw/wAA8P8AAPD/AAAAAAAAAAAAAA==" type="audio/wav">
        </audio>
    </div>

    <script>
        // --- 1. åˆæœŸè¨­å®šã¨å¤‰æ•°å®šç¾© ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let canvasWidth = window.innerWidth;
        let canvasHeight = window.innerHeight;
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;

        // éŸ³æºè¦ç´ ã®å–å¾—
        const bgm = document.getElementById('bgm');
        const jumpSound = document.getElementById('jumpSound');
        const itemSound = document.getElementById('itemSound');
        const clearSound = document.getElementById('clearSound');
        const gameOverSound = document.getElementById('gameOverSound'); // ãƒ€ãƒ¡ãƒ¼ã‚¸éŸ³ã¨ã—ã¦ä½¿ç”¨

        let isGameOver = false;
        let isGameStarted = false; // BGMå†ç”Ÿç®¡ç†ç”¨ã®ãƒ•ãƒ©ã‚°
        let score = 0;
        let lives = 3; // ãƒ©ã‚¤ãƒ• (HP)
        let gameSpeed = 4; // ã‚²ãƒ¼ãƒ ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦
        let animationId;
        let frameCount = 0;

        const groundHeight = 50;

        // ä¸»äººå…¬ (Player)
        const playerEmoji = 'ğŸƒ';
        const playerSize = 40;
        let player = {
            x: 50,
            y: canvasHeight - groundHeight - playerSize,
            width: playerSize * 0.8,
            height: playerSize * 0.8,
            dy: 0,
            gravity: 0.8,
            jumpPower: 14,
            isJumping: false,
            rotation: 0, // å›è»¢è§’åº¦
            rotationSpeed: 0.1, // é€šå¸¸æ™‚ã®å›è»¢é€Ÿåº¦
            isInvincible: false, // ç„¡æ•µçŠ¶æ…‹ãƒ•ãƒ©ã‚°
            invincibleTimer: 0 // ç„¡æ•µæ™‚é–“ã‚¿ã‚¤ãƒãƒ¼
        };

        // ã‚²ãƒ¼ãƒ è¦ç´  (éšœå®³ç‰©ã€ã‚¢ã‚¤ãƒ†ãƒ ) ã®é…åˆ—
        let elements = []; // { x, y, width, height, type, emoji, cleared }

        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºç”¨ã®é…åˆ—
        let popups = []; // { x, y, text, color, dy, opacity }

        // ã‚¢ã‚¤ãƒ†ãƒ ã¨éšœå®³ç‰©ã®çµµæ–‡å­—ãƒªã‚¹ãƒˆ
        const itemEmojis = ['ğŸ”', 'ğŸ°', 'ğŸ‡', 'ğŸŒ', 'ğŸ•', 'ğŸ©'];
        const groundObstacleEmojis = ['ğŸ¢', 'ğŸ„', 'ğŸŒµ', 'ğŸš§']; // åœ°ä¸Šéšœå®³ç‰©
        // â˜…ä¿®æ­£: ã‚ªãƒã‚± ğŸ‘» ã‚’è¿½åŠ 
        const airObstacleEmojis = ['ğŸ¦…', 'ğŸ¦‡', 'ğŸ', 'â˜ï¸', 'ğŸ‘»']; // ç©ºä¸­éšœå®³ç‰©
        const wallEmojis = ['ğŸ§±', 'ğŸ›ï¸', 'ğŸ—¼']; // å£ã®çµµæ–‡å­—

        // --- 2. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (æ“ä½œ) ---

        // BGMã‚„åŠ¹æœéŸ³ã‚’åˆæœŸåŒ–ãƒ»ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã™ã‚‹ãŸã‚ã®é–¢æ•°
        function unlockAudioContext() {
            if (isGameStarted) return;
            
            console.log("First interaction: Unlocking audio context...");
            bgm.volume = 0.5;
            
            const allAudio = [bgm, jumpSound, itemSound, clearSound, gameOverSound];

            allAudio.forEach(audio => {
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        if (audio !== bgm) {
                            audio.pause();
                            audio.currentTime = 0;
                        }
                    }).catch(error => {
                        console.log(`Audio unlock failed for ${audio.id}:`, error);
                    });
                }
            });
            
            isGameStarted = true;
        }

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (!isGameStarted) {
                unlockAudioContext();
            }

            if (isGameOver) {
                restartGame();
            } else {
                if (!player.isJumping) { 
                    player.dy = -player.jumpPower;
                    player.isJumping = true;
                    
                    if(isGameStarted) {
                        jumpSound.currentTime = 0;
                        jumpSound.play().catch(e => console.log("Jump sound failed", e)); 
                    }
                }
            }
        });

        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
        });

        window.addEventListener('resize', () => {
            canvasWidth = window.innerWidth;
            canvasHeight = window.innerHeight;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            if (player.y > canvasHeight - groundHeight - playerSize) {
                player.y = canvasHeight - groundHeight - playerSize;
            }
        });

        // --- 3. ä¸»äººå…¬ (Player) ã®æ›´æ–°ã¨æç”» ---

        function updatePlayer() {
            player.dy += player.gravity;
            player.y += player.dy;

            const groundY = canvasHeight - groundHeight - playerSize;
            let onPlatform = false;

            // éšæ®µçŠ¶ã®å£ã«ä¹—ã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            for (let el of elements) {
                if (el.type === 'stepWall' && player.dy >= 0) {
                    const playerBottom = player.y + player.height;
                    const playerRight = player.x + player.width;

                    if (playerRight > el.x && player.x < el.x + el.width &&
                        playerBottom >= el.y && playerBottom <= el.y + player.height / 2) {
                        player.y = el.y - player.height;
                        player.dy = 0;
                        onPlatform = true;
                        player.isJumping = false;
                        break;
                    }
                }
            }

            // åœ°é¢ã«ç€åœ°
            if (!onPlatform && player.y >= groundY) {
                player.y = groundY;
                player.dy = 0;
                player.isJumping = false;
            } else if (player.y < 0) { // ç”»é¢ä¸Šéƒ¨åˆ¶é™
                player.y = 0;
                player.dy = 0;
            }
            
            // å›è»¢æ›´æ–°
            if (player.isJumping) {
                player.rotationSpeed = 0.3; // ã‚¸ãƒ£ãƒ³ãƒ—ä¸­ã¯åŠ é€Ÿå›è»¢
            } else {
                player.rotationSpeed = 0.1; // é€šå¸¸å›è»¢
            }
            player.rotation += player.rotationSpeed;
            if (player.rotation > 2 * Math.PI) player.rotation -= 2 * Math.PI;

            // ç„¡æ•µæ™‚é–“ã®æ›´æ–°
            if (player.isInvincible) {
                player.invincibleTimer--;
                if (player.invincibleTimer <= 0) {
                    player.isInvincible = false;
                }
            }
        }

        function drawPlayer() {
            ctx.save(); 

            if (player.isInvincible) {
                if (Math.floor(player.invincibleTimer / 10) % 2 === 0) {
                    ctx.globalAlpha = 0.5; // åŠé€æ˜
                }
            }

            ctx.translate(player.x + player.width / 2, player.y + player.height / 2);
            ctx.rotate(player.rotation); 
            ctx.scale(-1, 1); // å·¦å³åè»¢

            ctx.font = `${playerSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(playerEmoji, 0, 0);

            ctx.restore(); 
        }

        // --- 4. ã‚²ãƒ¼ãƒ è¦ç´  (éšœå®³ç‰©ãƒ»ã‚¢ã‚¤ãƒ†ãƒ ) ã®ç®¡ç† ---

        function spawnElements() {
            frameCount++;
            
            if (frameCount % Math.floor(90 / (gameSpeed / 4)) === 0) { 
                const randomType = Math.random();
                const elementSize = 40;
                const groundY = canvasHeight - groundHeight;

                const lastElement = elements[elements.length - 1];
                const canSpawnHole = !lastElement || (lastElement.type !== 'hole' && lastElement.x < canvasWidth - 100);

                if (randomType < 0.1 && canSpawnHole) {
                    // 10% ç©´
                    elements.push({
                        x: canvasWidth, y: groundY,
                        width: 80 + Math.random() * 40, height: groundHeight,
                        type: 'hole', emoji: '', cleared: false
                    });
                } else if (randomType < 0.3) {
                    // 20% å£ (ãƒ©ãƒ³ãƒ€ãƒ ãªé«˜ã•ã€éšæ®µçŠ¶ã‚‚å«ã‚€)
                    let wallHeight = elementSize + Math.random() * 50;
                    let wallType = 'wall';
                    if (Math.random() < 0.3) { wallHeight = elementSize * 2 + Math.random() * 50; }
                    
                    if (Math.random() < 0.4 && wallHeight > elementSize + 20) {
                        wallType = 'stepWall';
                        const numSteps = 1 + Math.floor(Math.random() * 2);
                        const stepHeight = wallHeight / numSteps;
                        const stepWidth = (elementSize * 1.5) / numSteps;
                        
                        for(let i=0; i < numSteps; i++) {
                            elements.push({
                                x: canvasWidth + i * stepWidth, y: groundY - (i + 1) * stepHeight,
                                width: stepWidth, height: (i + 1) * stepHeight,
                                type: 'stepWall', emoji: wallEmojis[Math.floor(Math.random() * wallEmojis.length)],
                                color: '#A0522D', cleared: false
                            });
                        }
                    } else {
                        elements.push({
                            x: canvasWidth, y: groundY - wallHeight,
                            width: elementSize + Math.random() * 20, height: wallHeight,
                            type: wallType, emoji: wallEmojis[Math.floor(Math.random() * wallEmojis.length)],
                            color: '#8B4513', cleared: false
                        });
                    }
                } else if (randomType < 0.5) {
                    // 20% åœ°ä¸Šéšœå®³ç‰©
                    elements.push({
                        x: canvasWidth, y: groundY - elementSize,
                        width: elementSize, height: elementSize,
                        type: 'groundObstacle',
                        emoji: groundObstacleEmojis[Math.floor(Math.random() * groundObstacleEmojis.length)],
                        cleared: false
                    });
                } else if (randomType < 0.7) {
                    // 20% ç©ºä¸­æ•µ (â˜…èœ‚ã¨ã‚ªãƒã‚±ã®ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ )
                    const randomY = Math.random() * (canvasHeight - groundHeight - playerSize * 3) + playerSize;
                    const emoji = airObstacleEmojis[Math.floor(Math.random() * airObstacleEmojis.length)];
                    
                    let newElement = {
                        x: canvasWidth, y: randomY,
                        width: elementSize, height: elementSize,
                        type: 'airObstacle', emoji: emoji, cleared: false
                    };

                    // èœ‚ ğŸ ã®å ´åˆ: ã‚µã‚¤ãƒ³ã‚«ãƒ¼ãƒ–ç”¨ã®è¨­å®šã‚’è¿½åŠ 
                    if (emoji === 'ğŸ') {
                        newElement.movement = 'sine';
                        newElement.startY = randomY; // åŸºæº–ã®Yåº§æ¨™
                        newElement.angle = Math.random() * Math.PI * 2; // é–‹å§‹è§’åº¦ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«
                    }
                    // ã‚ªãƒã‚± ğŸ‘» ã®å ´åˆ: åœæ­¢/ç§»å‹•ç”¨ã®è¨­å®šã‚’è¿½åŠ 
                    else if (emoji === 'ğŸ‘»') {
                        newElement.movement = 'stop-go';
                        newElement.moveTimer = 60 + Math.random() * 60; // 1ã€œ2ç§’
                        newElement.isMoving = true; // æœ€åˆã¯å‹•ã
                    }

                    elements.push(newElement);

                } else {
                    // 30% ã‚¢ã‚¤ãƒ†ãƒ 
                    const randomY = Math.random() * (canvasHeight - groundHeight - playerSize * 2);
                    elements.push({
                        x: canvasWidth, y: randomY,
                        width: 30, height: 30,
                        type: 'item',
                        emoji: itemEmojis[Math.floor(Math.random() * itemEmojis.length)],
                        cleared: false
                    });
                }
            }
        }

        function updateAndDrawElements() {
            ctx.font = '40px Arial';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';

            for (let i = elements.length - 1; i >= 0; i--) {
                let el = elements[i];
                
                // â˜…ä¿®æ­£: æ•µã®ã‚¿ã‚¤ãƒ—ã«ã‚ˆã£ã¦å‹•ãã‚’å¤‰ãˆã‚‹
                if (el.movement === 'sine') {
                    // èœ‚ ğŸ: ã‚µã‚¤ãƒ³ã‚«ãƒ¼ãƒ–
                    el.x -= gameSpeed;
                    el.angle += 0.05 + (gameSpeed / 100); // ã‚²ãƒ¼ãƒ ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒä¸ŠãŒã‚‹ã¨æºã‚Œã‚‚é€Ÿããªã‚‹
                    el.y = el.startY + Math.sin(el.angle) * 20; // æŒ¯å¹… 20px
                } 
                else if (el.movement === 'stop-go') {
                    // ã‚ªãƒã‚± ğŸ‘»: åœæ­¢/ç§»å‹•
                    el.moveTimer--;
                    if (el.moveTimer <= 0) {
                        el.isMoving = !el.isMoving; // çŠ¶æ…‹åè»¢
                        el.moveTimer = 60 + Math.random() * 60; // 1ã€œ2ç§’ã‚¿ã‚¤ãƒãƒ¼ã‚»ãƒƒãƒˆ
                    }
                    if (el.isMoving) {
                        el.x -= gameSpeed; // å‹•ã„ã¦ã„ã‚‹ã¨ãã ã‘é€²ã‚€
                    }
                } 
                else {
                    // é€šå¸¸ã®è¦ç´ 
                    el.x -= gameSpeed;
                }


                // æç”»å‡¦ç†
                if (el.type === 'hole') {
                    // æç”»ãªã—
                } else if (el.type === 'wall' || el.type === 'stepWall') {
                    ctx.fillStyle = el.color || '#8B4513';
                    ctx.fillRect(el.x, el.y, el.width, el.height);
                    ctx.font = '30px Arial';
                    ctx.fillText(el.emoji, el.x + el.width / 2 - 15, el.y + el.height / 2 - 15);
                } else {
                    ctx.fillText(el.emoji, el.x, el.y);
                }

                if (el.x + el.width < 0) {
                    elements.splice(i, 1);
                }
            }
        }

        // --- 5. åœ°é¢ã®æç”» (ç©´ã‚’è€ƒæ…®) ---

        function drawGround() {
            ctx.fillStyle = '#4CAF50';
            
            let currentX = 0;
            let sortedHoles = elements.filter(el => el.type === 'hole')
                                      .sort((a, b) => a.x - b.x);
            
            for (let hole of sortedHoles) {
                if (hole.x > currentX) {
                    ctx.fillRect(currentX, canvasHeight - groundHeight, hole.x - currentX, groundHeight);
                }
                currentX = hole.x + hole.width;
            }
            
            if (currentX < canvasWidth) {
                ctx.fillRect(currentX, canvasHeight - groundHeight, canvasWidth - currentX, groundHeight);
            }
        }

        // --- 6. å½“ãŸã‚Šåˆ¤å®šã¨ã‚¹ã‚³ã‚¢åŠ ç®—ã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º ---

        function checkCollisions() {
            // é£›ã³è¶Šãˆåˆ¤å®šã¯å¸¸ã«å®Ÿè¡Œ
            checkClearance(); 

            // ç„¡æ•µä¸­ã¯å½“ãŸã‚Šåˆ¤å®šã‚’ã‚¹ã‚­ãƒƒãƒ—
            if (player.isInvincible) {
                return;
            }

            for (let i = elements.length - 1; i >= 0; i--) {
                let el = elements[i];

                const isColliding = player.x < el.x + el.width &&
                                  player.x + player.width > el.x &&
                                  player.y < el.y + el.height &&
                                  player.y + player.height > el.y;

                if (isColliding) {
                    if (el.type === 'item') {
                        // ã‚¢ã‚¤ãƒ†ãƒ å–å¾—
                        score += 30;
                        popups.push({ x: el.x, y: el.y, text: '+30', color: 'gold', dy: -2, opacity: 1 });
                        itemSound.currentTime = 0;
                        itemSound.play().catch(e => console.log("Item sound failed", e));
                        elements.splice(i, 1);
                    } else if (el.type === 'wall' || el.type === 'groundObstacle' || el.type === 'airObstacle' || el.type === 'stepWall' ||
                               (el.type === 'hole' && player.y + player.height >= canvasHeight - groundHeight)) {
                        
                        // éšœå®³ç‰©ã€æ•µã€ã¾ãŸã¯ç©´ã«è½ã¡ãŸ
                        lives--;
                        gameOverSound.currentTime = 0;
                        gameOverSound.play().catch(e => console.log("Damage sound failed", e));
                        
                        if (lives <= 0) {
                            isGameOver = true;
                        } else {
                            // ã¾ã ãƒ©ã‚¤ãƒ•ãŒæ®‹ã£ã¦ã„ã‚‹
                            player.isInvincible = true;
                            // ç„¡æ•µæ™‚é–“ã‚’3ç§’(180)ã«å»¶é•·
                            player.invincibleTimer = 180; 
                            
                            if (el.type !== 'hole') {
                                // ç©´ä»¥å¤–ã¯ã€å½“ãŸã£ãŸéšœå®³ç‰©ã‚’æ¶ˆã™
                                elements.splice(i, 1);
                            } else {
                                // ç©´ã«è½ã¡ãŸå ´åˆã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åœ°é¢ã«æˆ»ã™
                                player.y = canvasHeight - groundHeight - playerSize;
                                player.dy = -player.jumpPower * 0.5; // å°‘ã—ã ã‘è·³ã­è¿”ã‚‹
                            }
                        }
                    }
                }
            }
        }
        
        // é£›ã³è¶Šãˆåˆ¤å®š
        function checkClearance() {
            for (let el of elements) {
                if (el.cleared) continue; 
                
                if (player.x > el.x + el.width) {
                    if ((el.type === 'wall' || el.type === 'groundObstacle' || el.type === 'hole' || el.type === 'stepWall') &&
                        player.y < canvasHeight - groundHeight - player.height / 2) {
                        
                        score += 10;
                        popups.push({ x: el.x, y: el.y, text: '+10', color: 'lightgreen', dy: -2, opacity: 1 });
                        clearSound.currentTime = 0;
                        clearSound.play().catch(e => console.log("Clear sound failed", e));
                        el.cleared = true;
                    } else if (el.type === 'airObstacle' && player.y < el.y + el.height) {
                        
                        score += 20;
                        popups.push({ x: el.x, y: el.y, text: '+20', color: 'skyblue', dy: -2, opacity: 1 });
                        clearSound.currentTime = 0;
                        clearSound.play().catch(e => console.log("Clear sound failed", e));
                        el.cleared = true;
                    }
                }
            }
        }
        
        // --- 7. UI (ã‚¹ã‚³ã‚¢ãƒ»ãƒ©ã‚¤ãƒ•ãƒ»ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—) æç”» ---

        function drawUI() {
            // ã‚¹ã‚³ã‚¢æç”»
            ctx.fillStyle = 'black';
            ctx.font = '24px Arial';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'top';
            ctx.fillText(`Score: ${score}`, canvasWidth - 20, 20);

            // ãƒ©ã‚¤ãƒ•æç”»
            let hearts = '';
            for (let i = 0; i < lives; i++) {
                hearts += 'â¤ï¸';
            }
            ctx.fillStyle = 'red';
            ctx.font = '24px Arial';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.fillText(hearts, 20, 20);
        }

        function drawPopups() {
            for (let i = popups.length - 1; i >= 0; i--) {
                let p = popups[i];
                p.y += p.dy;
                p.opacity -= 0.02;
                
                if (p.opacity <= 0) {
                    popups.splice(i, 1);
                } else {
                    let colorString = '255, 255, 255'; // default white
                    if (p.color === 'gold') colorString = '255, 215, 0';
                    else if (p.color === 'lightgreen') colorString = '144, 238, 144';
                    else if (p.color === 'skyblue') colorString = '135, 206, 235';
                    
                    ctx.fillStyle = `rgba(${colorString}, ${p.opacity})`;
                    ctx.font = 'bold 20px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(p.text, p.x + 20, p.y);
                }
            }
        }

        function drawGameOver() {
            cancelAnimationFrame(animationId); 
            bgm.pause(); // BGMåœæ­¢

            ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            ctx.fillText('Game Over', canvasWidth / 2, canvasHeight / 2 - 40);
            ctx.font = '30px Arial';
            ctx.fillText(`Final Score: ${score}`, canvasWidth / 2, canvasHeight / 2);
            
            ctx.font = '20px Arial';
            ctx.fillText('Tap to Restart', canvasWidth / 2, canvasHeight / 2 + 50);
        }

        // --- 8. ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–ãƒ»ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ ---

        function restartGame() {
            score = 0;
            lives = 3; // ãƒ©ã‚¤ãƒ•ã‚’ãƒªã‚»ãƒƒãƒˆ
            gameSpeed = 4;
            frameCount = 0;
            elements = [];
            popups = [];
            player.y = canvasHeight - groundHeight - playerSize;
            player.dy = 0;
            player.isJumping = false;
            player.rotation = 0;
            player.rotationSpeed = 0.1;
            player.isInvincible = false; // ç„¡æ•µçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            player.invincibleTimer = 0;
            isGameOver = false;
            isGameStarted = true; 

            bgm.currentTime = 0; 
            bgm.play().catch(e => console.log("BGM restart failed", e));
            gameLoop();
        }

        // --- 9. ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ— ---

        function gameLoop() {
            if (isGameOver) {
                drawGameOver();
                return;
            }

            ctx.clearRect(0, 0, canvasWidth, canvasHeight);

            drawGround();
            spawnElements();
            updateAndDrawElements();
            updatePlayer();
            drawPlayer();
            checkCollisions();
            drawPopups(); 
            drawUI(); 
            
            // ã‚²ãƒ¼ãƒ ã‚¹ãƒ”ãƒ¼ãƒ‰ä¸Šæ˜‡ (é›£æ˜“åº¦ã‚¢ãƒƒãƒ—)
            if (score > 0 && frameCount % 120 === 0) { // æ™‚é–“çµŒéï¼ˆç´„2ç§’ã”ã¨ï¼‰ã§é›£æ˜“åº¦ã‚’ãƒã‚§ãƒƒã‚¯
                if(gameSpeed < 10) gameSpeed += 0.05; // å¢—åŠ é‡ã‚’ç·©ã‚„ã‹ã«
            }

            animationId = requestAnimationFrame(gameLoop);
        }

        // --- 10. ã‚²ãƒ¼ãƒ é–‹å§‹ ---
        bgm.volume = 0.5;
        // BGMã®è‡ªå‹•å†ç”Ÿã¯ 'touchstart' ã‚¤ãƒ™ãƒ³ãƒˆã«ç§»å‹•
        
        gameLoop(); // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—é–‹å§‹

    </script>
</body>
</html>
